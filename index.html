<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Playfair+Display&family=Roboto&display=swap"
        rel="stylesheet">
    <link rel=" icon" href="./img/cadetlogo_prev_ui.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome for professional icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* ðŸ”¥ Full-screen loader styles */
        /* Full-page loader background */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            /* Hide by default */
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Your custom image styling */
        .loader-icon {
            width: 200px;
            /* Adjust size */
            height: auto;
            animation: spin 3s linear infinite;
            /* Add animation */
        }

        .new {
            font-size: 13px;
        }

        /* Spin animation */
        @keyframes spin {
            100% {
                transform: rotate(300deg);
            }
        }

        /* Cool and professional links section */
        .quick-links-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1px;
        }

        .quick-link-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #1a202c;
            /* Dark background */
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .quick-link-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .quick-link-item .icon {
            font-size: 2rem;
            color: #4a90e2;
            /* Accent color */
        }

        .quick-link-item a {
            color: #fff;
            font-size: 1.25rem;
            font-weight: bold;
            text-decoration: none;
        }
    </style>

    <script>
        function shakeText(element) {
            element.classList.add('shake');
            setTimeout(() => {
                element.classList.remove('shake');
            }, 1000);
        }

        function fadeInText(element) {
            element.style.opacity = 0;
            let opacity = 0;
            const interval = setInterval(() => {
                if (opacity >= 1) {
                    clearInterval(interval);
                }
                opacity += 0.05;
                element.style.opacity = opacity;
            }, 50);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const textToShake = document.getElementById('shake-text');
            shakeText(textToShake);
            fadeInText(textToShake);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('page-loader');
            if (!loader) console.warn('No #page-loader element found (create one under <body>)');

            // Helper: ignore mailto, tel, pure hashes or javascript: links
            function shouldIgnoreHref(href) {
                if (!href) return true;
                href = href.trim();
                return href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('#') || href.startsWith('javascript:');
            }

            // Get all nav links that look like real internal pages
            const navLinks = Array.from(document.querySelectorAll('nav a[href]')).filter(a => !shouldIgnoreHref(a.getAttribute('href')));
            console.log('Loader: nav links found ->', navLinks.length);

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    // allow open-in-new-tab or modifier keys
                    if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

                    // Prevent navigation, show loader, then navigate
                    e.preventDefault();

                    // Make sure href is absolute so it still works when in subfolders
                    const targetHref = new URL(this.getAttribute('href'), location.href).href;

                    try {
                        if (loader) {
                            loader.style.display = 'flex';
                            // optional: make the loader opaque and prevent scroll
                            document.documentElement.style.overflow = 'hidden';
                            document.body.style.overflow = 'hidden';
                            // force reflow so the loader paint happens before we navigate
                            void loader.offsetWidth;
                            console.log('Loader displayed, navigating to', targetHref);
                        } else {
                            console.log('No loader found â€” navigating immediately to', targetHref);
                        }
                    } catch (err) {
                        console.error('Loader show error', err);
                    }

                    // short delay so user sees the loader; adjust ms as you like
                    setTimeout(() => {
                        // restore overflow (not strictly necessary as page will unload)
                        document.documentElement.style.overflow = '';
                        document.body.style.overflow = '';
                        window.location.href = targetHref;
                    }, 1200); // 600ms feels snappy; use 1200 or 1500 if you prefer longer
                });
            });

            // Debug helper: expose a quick test function in console
            window.__loaderDebug = () => {
                console.log('page-loader element:', document.getElementById('page-loader'));
                console.log('nav a[href] count:', document.querySelectorAll('nav a[href]').length);
            };
        });

    </script>

</head>

<body>

    <!-- ðŸ”¥ Loader HTML -->
    <div id="page-loader">
        <img src="./img/cadetlogo_prev_ui.png" alt="Loading..." class="loader-icon">
    </div>


    <header>
        <div class="logo">
            <a href="index.html"><img src="./img/cadetlogo_prev_ui.png" alt="Cadet Logo"></a>
        </div>
        <div class="logo-right">
            <a href="about.html"><img src="./img/image.png" alt="3rd Brigade Logo"></a>
        </div>
        <nav>
            <ul class="new">
                <li><a href="#home">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="careers.html">Careers</a></li>
                <li><a href="apply.php">Apply</a></li>
            </ul>
        </nav>
    </header>

    <section id="hero">
        <div class="videoWrapper">
            <iframe src="https://www.dvidshub.net/video/embed/653017?autoplay=1&muted=1" width="800" height="450"
                frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
        <div class="hero-text">
            <h1 id="shake-text">Join the 3rd Brigade</h1>
            <p>Train with the best and <br> become a leader of tomorrow.</p>
            <a href="apply.php" class="btn">Apply Now</a>
        </div>
    </section>

    <!-- New section for Dashboard and News quick links -->
    <section class="quick-links-container">
        <div class="quick-link-item">
            <a href="user_dashboard.php">
                <i class="fas fa-chart-bar icon"></i>
                <span>Dashboard</span>
            </a>
        </div>
        <div class="quick-link-item">
            <a href="news.php">
                <i class="fas fa-bullhorn icon"></i>
                <span>News</span>
            </a>
        </div>
    </section>

    <section class="fancy-bg">
        <div class="content-wrapper">
            <div class="big-text">Our Mission</div>
            <p class="mission-text">
                To prepare and develop future leaders through trainings and strong values.
                Join us to learn teamwork, discipline, and leadership skills essential for success
                in the Army and beyond.
            </p>
            <div class="quote-box">
                <blockquote>
                    "A leader is one who knows the way, goes the way, and shows the way."
                </blockquote>
                <cite>- John C. Maxwell</cite>
            </div>
        </div>
    </section>


    <section>
        <div class="image-container">
            <img src="./img/Dril2.png" alt="Army Cadets in Training">
            <img src="./img/oyocdtsalut.jpeg" alt="Army Cadet Marching">
            <img src="./img/P4.jpg" alt="Army Cadet Leadership Development">
        </div>
    </section>


    <footer>
        <div class="footer-links">
            <div><a href="contact.php">Contact Us</a></div>
            <div><a href="faqs.html">FAQs</a></div>
            <div><a href="gallery.html">Gallery</a></div>
            <div><a href="privacy.html">Privacy Policy</a></div>
            <div><a href="developer.html">About the Developer</a></div>
            <div><a href="https://www.facebook.com" target="_blank">Facebook</a></div>
            <div><a href="https://www.instagram.com" target="_blank">Instagram</a></div>
            <div><a href="https://www.tiktok.com" target="_blank">TikTok</a></div>
            <div><a href="mailto:nccnoyonigeria@gmail.com" target="_blank">Gmail</a></div>
        </div>
        <p>&copy; 2024 3rd Brigade Headquarters. All Rights Reserved.</p>
    </footer>
    <script type="module">
        // This script must be included on every page you wish to track.
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            updateDoc,
            getDoc,
            increment,
            setLogLevel,
            setDoc // Added to create the document if it doesn't exist
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- Configuration Setup ---
        const MOCK_FIREBASE_CONFIG = {
            apiKey: "MOCK_KEY_TO_ALLOW_INIT",
            authDomain: "mock-project.firebaseapp.com",
            projectId: "mock-project-id",
            storageBucket: "mock-project.appspot.com",
            appId: "1:123456789012:web:abcdef123456"
        };

        const envConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        let firebaseConfig;

        try {
            firebaseConfig = envConfigRaw ? JSON.parse(envConfigRaw) : MOCK_FIREBASE_CONFIG;
            if (!firebaseConfig.projectId) {
                firebaseConfig = MOCK_FIREBASE_CONFIG;
            }
        } catch (e) {
            firebaseConfig = MOCK_FIREBASE_CONFIG;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-app';

        // Key used to store the last visit timestamp in localStorage
        const LOCAL_STORAGE_KEY = 'portal_unique_visitor';
        // The main Firestore path for the visitors document
        const VISITORS_DOC_PATH = `artifacts/${appId}/public/data/analytics/visitors`;
        // --- End Configuration Setup ---

        /**
         * Checks if 24 hours have passed since the last visit.
         * @param {number} lastVisitTimestamp - Unix timestamp in milliseconds.
         * @returns {boolean} True if the visitor is new or 24 hours have passed.
         */
        const isNewVisitor = (lastVisitTimestamp) => {
            if (!lastVisitTimestamp) return true;
            const now = Date.now();
            // 24 hours in milliseconds
            const twentyFourHours = 24 * 60 * 60 * 1000;
            return (now - lastVisitTimestamp) > twentyFourHours;
        };

        /**
         * Resets the daily count in Firestore if a new day has started.
         * @param {object} docData - The current data from the Firestore document.
         * @param {object} docRef - The Firestore document reference.
         */
        const rotateDataIfNewDay = async (docData, docRef) => {
            const now = new Date();
            // Determine if the local time is a new day compared to the last recorded update
            const lastUpdateDate = docData.lastUpdated ? new Date(docData.lastUpdated) : new Date(0);

            // Simple check: Is the current day number different from the last update's day number?
            if (now.getDate() !== lastUpdateDate.getDate() || now.getMonth() !== lastUpdateDate.getMonth()) {

                // 1. Prepare to shift the data: Drop Monday's data, shift everything left, and reset Sunday's count to 0.
                const currentDailyData = docData.dailyData || [];
                let newDailyData = [];

                if (currentDailyData.length === 7) {
                    // Shift data: Tue becomes Mon, Wed becomes Tue, etc.
                    newDailyData = [
                        { date: 'Mon', count: currentDailyData[1].count },
                        { date: 'Tue', count: currentDailyData[2].count },
                        { date: 'Wed', count: currentDailyData[3].count },
                        { date: 'Thu', count: currentDailyData[4].count },
                        { date: 'Fri', count: currentDailyData[5].count },
                        { date: 'Sat', count: currentDailyData[6].count },
                        { date: 'Sun', count: 0 } // Sunday (today) starts at 0
                    ];
                } else {
                    // If data structure is invalid, use mock structure to prevent crashes
                    newDailyData = [
                        { date: 'Mon', count: 0 },
                        { date: 'Tue', count: 0 },
                        { date: 'Wed', count: 0 },
                        { date: 'Thu', count: 0 },
                        { date: 'Fri', count: 0 },
                        { date: 'Sat', count: 0 },
                        { date: 'Sun', count: 0 }
                    ];
                }

                console.log("New day detected. Resetting count and rotating daily data.");

                await updateDoc(docRef, {
                    todayCount: 0,
                    dailyData: newDailyData,
                    lastUpdated: now.toISOString()
                });

                // Return true to indicate a reset happened
                return true;
            }

            // Return false to indicate no reset happened
            return false;
        };

        /**
         * Main tracking function executed on page load.
         */
        const trackVisitor = async () => {
            let app, db, auth;
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Authenticate (Anonymously is usually sufficient for a tracker)
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                const lastVisit = localStorage.getItem(LOCAL_STORAGE_KEY);

                if (isNewVisitor(lastVisit)) {

                    const visitorsDocRef = doc(db, VISITORS_DOC_PATH);
                    const docSnap = await getDoc(visitorsDocRef);

                    let countIncremented = false;

                    if (docSnap.exists()) {
                        const docData = docSnap.data();

                        // Check if a new day has started, and reset if necessary
                        await rotateDataIfNewDay(docData, visitorsDocRef);

                        // 2. Increment the count atomically
                        await updateDoc(visitorsDocRef, {
                            todayCount: increment(1),
                            // Also update the daily array's current day count (Sun is the 6th index)
                            'dailyData.6.count': increment(1)
                        });

                        console.log(`Unique Visitor counted. Total count incremented by 1.`);
                        countIncremented = true;
                    } else {
                        // FIX: Document does not exist. Create it with initial structure and set count to 1.
                        const initialDailyData = [
                            { date: 'Mon', count: 0 }, { date: 'Tue', count: 0 }, { date: 'Wed', count: 0 },
                            { date: 'Thu', count: 0 }, { date: 'Fri', count: 0 }, { date: 'Sat', count: 0 },
                            { date: 'Sun', count: 0 }
                        ];

                        // Today's visit is 1, apply it to the Sunday index (6) for consistency with the dashboard chart
                        initialDailyData[6].count = 1;

                        await setDoc(visitorsDocRef, {
                            todayCount: 1,
                            dailyData: initialDailyData,
                            lastUpdated: new Date().toISOString()
                        });

                        console.log("Visitors document created and counted first unique visit.");
                        countIncremented = true;
                    }

                    // 3. Update localStorage timestamp only if the count was successfully incremented
                    if (countIncremented) {
                        localStorage.setItem(LOCAL_STORAGE_KEY, Date.now().toString());
                    }

                } else {
                    console.log("Visitor counted within the last 24 hours. No action taken.");
                }

            } catch (error) {
                // Log error but do not disrupt the user's experience
                console.error("Unique Visitor Tracking Error:", error);
            }
        };

        // Run the tracking logic on page load
        window.addEventListener('load', trackVisitor);
    </script>

</body>

</html>